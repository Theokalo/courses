<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Ενότητα 2-3 &mdash; Internet Programming Lectures v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Internet Programming Lectures v1.0 documentation" href="../index.html" />
    <link rel="next" title="Ενότητα 2-4" href="module4.html" />
    <link rel="prev" title="Ενότητα 2-2" href="module2.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="module4.html" title="Ενότητα 2-4"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="module2.html" title="Ενότητα 2-2"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Internet Programming Lectures v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>Ενότητα 2-3<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="web-page-scraping-regular-expressions">
<span id="rexp-extract-weather"></span><h2>Web page scraping με regular expressions<a class="headerlink" href="#web-page-scraping-regular-expressions" title="Permalink to this headline">¶</a></h2>
<p>Στο παράδειγμα που ακολουθεί θέλουμε να εξάγουμε την πληροφορία πρόβλεψης καιρού από site, όπου η πληροφορία που μας ενδιαφέρει έχει τη μορφή διαδοχικών γραμμών &lt;tr&gt; πίνακα HTML με εναλλασσόμενο style <tt class="docutils literal"><span class="pre">TRstyle0</span></tt> και <tt class="docutils literal"><span class="pre">TRstyle1</span></tt> :</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">&quot;TRstyle1&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;DatesG&quot;</span><span class="nt">&gt;</span>Κυριακή<span class="nt">&lt;/span&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;HeadG&quot;</span><span class="nt">&gt;</span>16/05/2010<span class="nt">&lt;span&gt;&lt;/td&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;</span>21:00<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">&quot;db_graphics/18UTC_s.gif&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
<span class="c">&lt;!--Temperature start--&gt;</span><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabGB&quot;</span><span class="nt">&gt;</span>18 <span class="ni">&amp;deg;</span>C<span class="nt">&lt;/td&gt;</span>
<span class="c">&lt;!--end temperature --&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;</span>61%<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;</span>6 Μποφόρ Δ<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">&quot;db_graphics/WindDirectionD.gif&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">&quot;db_graphics/ws3.gif&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;</span>ΒΡΟΧΗ<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;TabG&quot;</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">&quot;db_graphics/HeavyRain.gif&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></div>
</div>
<p>Σύμφωνα με τις προηγούμενες ενότητες, αρχικά ανακτούμε την πλήρη ιστοσελίδα σε ένα string, με τη βοήθεια του module <tt class="docutils literal"><span class="pre">urllib</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">page</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;page.url&quot;</span><span class="p">)</span>
<span class="n">pagetext</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;iso8859_7&quot;</span><span class="p">)</span>
<span class="n">page</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Παρατηρήστε ότι η σελίδα είναι σε κωδικοποίηση ISO 8859-7, την οποία μετατρέπουμε σε unicode.</p>
<p>Στη συνέχεια χρησιμοποιούμε την RE <tt class="docutils literal"><span class="pre">&lt;tr</span> <span class="pre">class=&quot;TRstyle[01]&quot;&gt;(.+?)&lt;/tr&gt;</span></tt> για να εξάγουμε τα σημεία των προβλέψεων. Παρατηρήστε ότι προβλέπουμε για τις εναλλαγές του TRstyle με το <tt class="docutils literal"><span class="pre">[01]</span></tt>, καθώς και τη χρήση του μη άπληστου <tt class="docutils literal"><span class="pre">+?</span></tt> για την επιλογή του περιεχομένου (αλλιώς η πρώτη επιλογή θα περιελάμβανε τα πάντα μέχρι το τελευταίο &lt;/tr&gt; της ιστοσελίδας!):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">restr</span> <span class="o">=</span> <span class="s">r&#39;&lt;tr class=&quot;TRstyle[01]&quot;&gt;(.+?)&lt;/tr&gt;&#39;</span>
<span class="n">rexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">restr</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rexp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pagetext</span><span class="p">)</span>
</pre></div>
</div>
<p>Η findall() θα επιστρέψει μια λίστα <tt class="docutils literal"><span class="pre">m</span></tt> με κείμενο που περιλαμβάνεται μεταξύ των &lt;tr class=&#8221;TRstyle..&#8221;&gt; και &lt;/tr&gt; (άλλα όχι και τα ίδια τα &lt;tr&gt; και &lt;/tr&gt; tags).</p>
<p>Αμέσως μετά, για κάθε ένα στοιχείο της λίστας <tt class="docutils literal"><span class="pre">m</span></tt>, εξάγουμε με τον ίδιο τρόπο το κείμενο μεταξύ &lt;td&gt; και &lt;/td&gt;. Παρατηρήστε ότι με το <tt class="docutils literal"><span class="pre">&lt;td[^&gt;]+&gt;</span></tt> επιλέγουμε όλα τα &lt;td&gt; tags, χωρίς να μας απασχολούν τα attributes που περιέχουν αυτά:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">restr2</span> <span class="o">=</span> <span class="s">r&#39;&lt;td[^&gt;]+&gt;(.+?)&lt;/td&gt;&#39;</span>
<span class="n">rexp2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">restr2</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">rexp2</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
<p>Το <tt class="docutils literal"><span class="pre">m2</span></tt> σε κάθε επανάληψη είναι επίσης λίστα, η οποία περιέχει για παράδειγμα τα παρακάτω strings:</p>
<div class="highlight-python"><pre>&lt;span class="DatesG"&gt;Κυριακή&lt;/span&gt;&lt;span class="HeadG"&gt;16/05/2010&lt;/span&gt;
15:00
&lt;img src="db_graphics/12UTC_s.gif"&gt;
19 &amp;deg;C
56%
7 Μποφόρ ΝΔ
&lt;img src="db_graphics/WindDirectionND.gif"&gt;
&lt;img src="db_graphics/ws4.gif"&gt;
ΒΡΟΧΗ
&lt;img src="db_graphics/HeavyRain.gif"&gt;</pre>
</div>
<p>Προφανώς ενδιαφερόμαστε για τα στοιχεία 0 (ημέρα/ημερομηνία), 1 (ώρα), 3 (θερμοκρασία), 4 (υγρασία), 5 (άνεμος), 8 (καιρός). Όλα εκτός από το m2[0] είναι έτοιμα για χρήση. Το m2[0] μπορούμε να το επεξεργαστούμε πάλι με τη εξής R.E. (δημιουργούμε το rexp3 πριν το for):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">restr3</span> <span class="o">=</span> <span class="s">r&#39;&lt;span[^&gt;]+&gt;(.+?)&lt;/span&gt;&#39;</span>
<span class="n">rexp3</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">restr3</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</pre></div>
</div>
<p>Τελικά, ο κώδικας του for έχει τη μορφή:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">rexp2</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">day</span><span class="p">,</span><span class="n">date</span> <span class="o">=</span> <span class="n">rexp3</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">m2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">m2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">m2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">u&quot;&amp;deg;&quot;</span><span class="p">,</span><span class="nb">unichr</span><span class="p">(</span><span class="mi">176</span><span class="p">))</span>
        <span class="n">humid</span> <span class="o">=</span> <span class="n">m2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">wind</span> <span class="o">=</span> <span class="n">m2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">sky</span> <span class="o">=</span> <span class="n">m2</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">outstr</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">day</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">humid</span><span class="p">,</span><span class="n">wind</span><span class="p">,</span><span class="n">sky</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">outstr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf_8&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Όπως φαίνεται στον κώδικα, για εμφάνιση στην κονσόλα μετατρέπουμε το κείμενο από unicode σε UTF-8. Επίσης, μετατρέπουμε το <tt class="docutils literal"><span class="pre">&amp;deg;</span></tt> στο σωστό σύμβολο <tt class="docutils literal"><span class="pre">°C</span></tt>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Μία τελευταία παρατήρηση</strong>: κατά τη διαδικασία του web page scraping, προσπαθούμε να εντοπίσουμε ένα σταθερό σχήμα που οριοθετεί την πληροφορία που μας ενδιαφέρει. Αν το σχήμα αυτό αλλάξει, θα πρέπει να τροποποιήσουμε και το πρόγραμμά μας. Προσοχή σε σχήματα που δεν εμφανίζονται συχνά: στο site του παραδείγματος υπάρχει περίπτωση να εμφανιστεί επιπρόσθετη πληροφορία &#8220;αισθητής θερμοκρασίας&#8221;. Η πληροφορία αυτή ανατρέπει το σχεδιασμό μας και απαιτεί διορθώσεις στον κώδικα που είδαμε προηγουμένως.</p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="module4.html" title="Ενότητα 2-4"
             >next</a> |</li>
        <li class="right" >
          <a href="module2.html" title="Ενότητα 2-2"
             >previous</a> |</li>
        <li><a href="../index.html">Internet Programming Lectures v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2011, mistral.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.6.
    </div>
  </body>
</html>